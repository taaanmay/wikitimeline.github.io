<html>
	<head>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
  		<script src="https://d3js.org/d3.v5.min.js"></script>
  		<script src="https://d3js.org/d3-collection.v1.min.js"></script>
  		<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  		<script src="https://d3js.org/d3-request.v1.min.js"></script>

		<script type="text/javascript">
    
	var wikiData = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql'		// Link to access wiki data SPARQL database

	const queryString = window.location.search;										// returns: ?subj=...								

	const urlParams = new URLSearchParams(queryString);
	const subject = urlParams.get('subj');											// isolates subj eg: https://www.wikidata.org/wiki/Q937
	
	var data2;

	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(loadData);

	function loadData(){
		data2 = new google.visualization.DataTable();

    	//data2.addColumn('string', 'ID');
		data2.addColumn({ type: 'string', label: 'Predicate', id: 'pName'});
		data2.addColumn({ type: 'string', label: 'Object', id: 'oName'});
		data2.addColumn({ type: 'date', label: 'Start Date', id: 'start'});
		data2.addColumn({ type: 'date', label: 'End Date', id: 'end'});
		data2.addColumn({ type: 'string', role: 'tooltip', id: 'link', 'p': {'html': true} });


	}

	// First SPARQL query for non-star triples
	// retrieves birth/start date & death/end date
	var datesQuery = `
		PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
		PREFIX wikibase: <http://wikiba.se/ontology#>
		PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		SELECT ?pred ?obj ?pName WHERE {
  			<`+subject+`> ?pred ?obj.
  			FILTER ( (datatype(?obj) = xsd:dateTime) || (datatype(?obj) = xsd:date) || (datatype(?obj) = xsd:gYear) || (datatype(?obj) = xsd:gYearMonth) ).
  			?x wikibase:directClaim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
		}
		LIMIT 200
	`;

	var deathDate = new Date();												// Assume query has no end/death date, set to current date

d3.sparql(wikiData, datesQuery).then(function(data) {

	console.log("We got birth data and death date for QUERY1");
	console.log(data);


	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(loadData2);


	function loadData2(){

		data.forEach(function (arrayItem) {
			var startDate = new Date(arrayItem.obj);
			var endDate = new Date(startDate.getTime()+1000*60*60*24);

	   		data2.addRows([
	   			[ String(arrayItem.pName), String(arrayItem.pName),
	 			   startDate, endDate, String(subject) ]
	   		]);
			
			// Update death date if query has a death date
			if(arrayItem.pName ==="date of death")									// There is a death/end date
			{
				console.log("Has DEATH DATE");
				deathDate = new Date(arrayItem.obj);
			}
		});
	};
});

    //Second SPARQLStar query
	// Finds data between birth/start date & death/end date or present date
    var starQuery = `
    	SELECT DISTINCT ?pred ?pName ?obj ?oName ?start ?end WHERE {
  			<`+subject+`> ?pred ?statement.
  			?statement ?predPS ?obj;
    			pq:P580 ?start.
  			OPTIONAL { ?statement pq:P582 ?end. FILTER(?end >= ?start).}
  			FILTER(STRSTARTS(STR(?predPS), "http://www.wikidata.org/prop/statement/"))
  			FILTER(STRSTARTS(STR(?pred), "http://www.wikidata.org/prop/"))
  			FILTER(STRSTARTS(STR(?statement), "http://www.wikidata.org/entity/statement/"))
  			?x wikibase:claim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
  			?obj rdfs:label ?oName.
  			FILTER((LANG(?oName)) = "en")
		}
		LIMIT 200`;

d3.sparql(wikiData, starQuery).then(function(data) {

	console.log(data);
	////////////////////////////
	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(drawChart);


    function drawChart() {

	    //var today = new Date();
	    //today = Date.now();
		if(data.length==0)					//Need to print something to web-page rather than to console
		{
			console.log("Invalid query");
			return;
		}
	    data.forEach(function (arrayItem) {
	    	var startDate = new Date(arrayItem.start);
			//var endDate = arrayItem.end ? new Date(arrayItem.end) : new Date(startDate.getTime()+1000*60*60*24);
			var currentDate = deathDate;
			// if array item has an end date, then stop timeline at this end date specified
			// otherwise, draw the timeline from start date to present date
			var endDate = arrayItem.end ? new Date(arrayItem.end) : new Date(currentDate.getTime());
	    	data2.addRows([
	    		[ String(arrayItem.pName), String(arrayItem.oName),
                 //startDate, endDate , String("https://yagotimeline.github.io/search.html?subj=" +arrayItem.obj) ]	// Allows new timelines to be clicked which then shows new data for this timeline
				 startDate, endDate , String("file:///F:/3rd%20Year/Semester2/SWENG/yagoTimeline.github.io/search.html?subj="+arrayItem.obj) ] // local copy of file on David's machine

	    	]);
	    });

		// sort startDate column
		// Ensures data is displayed in chronological order
		// May already come in chronological order, need to investigate 
    	data2.sort({
      		column: 2,
      		desc: false
    	});

		// Options for google charts visualisation
	    var options = {
			timeline: { groupByRowLabel: false },		//Prevents timelines being drawn on same line			
			backgroundColor: '#ffd'						//Sets background color of chart

		};

		var chart = new google.visualization.Timeline(document.getElementById('chart_div'));

		google.visualization.events.addListener(chart, 'select', function () {
    		var selection = chart.getSelection();
    		if (selection.length > 0) {
      			window.open(data2.getValue(selection[0].row, 4), '_self'); //to open in a new tab use -> '_blank');
      			console.log(data2.getValue(selection[0].row, 4));
    		}
  		});

	    chart.draw(data2, options);

	};
});

		</script>
	</head>
	<body>
		<h3>Insert a resource name (e.g. "Albert_Einstein" or "European_Union" etc), select the corresponding query from the drop down list and press "Submit" to start exploring timelines:</h3>
		<input type="text" class="searchbox" id="text" />
		<input type='hidden' id='textID' />

        <!-- <input type="button" id="btn" value="Submit" onClick="javascript: window.open('http://yagoTimeline.github.io/search.html?subj=http://www.wikidata.org/entity/' + document.getElementById('textID').value, '_self');" /> -->
		 <input type="button" id="btn" value="Submit" onClick="javascript: window.open('file:///F:/3rd%20Year/Semester2/SWENG/yagoTimeline.github.io/search.html?subj=http://www.wikidata.org/entity/' + document.getElementById('textID').value, '_self');" />
		
		<p>Or click on the items in the timeline below:</p>
		<div id="chart_div" style="overflow-x: scroll; overflow-y: scroll; height: 85%; width: 100%; "></div>
		

		<!-- Search wikiData SPARQL database and retrieve corrsepond Qxyz-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
		
		<script type="text/javascript">
		$(".searchbox").autocomplete({
		    source: function(request, response) {
		        console.log(request.term);
		        $.ajax({
		            url: "https://www.wikidata.org/w/api.php",
		            dataType: "jsonp",
		            data: {
		                'action': "wbsearchentities",
		                'format': "json",
				'language': "en",
		                'search': request.term
		            },
		            success: function(data) {
		                //response(data.search);
				response( $.map(data.search, function(item) {
					return {
						label: item.label + " (" + item.description + ")",
						value: item.label,
						id: item.id,
						description: item.description
					}
				}));
		            }
		        });
		    },
		    minLength: 3,
		    select: function( event, ui ) {
				console.log( "Selected: " + ui.item.label + ", having the Wikidata entity: " + ui.item.id );
				$("#text").val(ui.item.value);
				$("#textID").val(ui.item.id); return false;
		    }
		});
		</script>
	</body>
</html> 

