<html>
	<head>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
  		<script src="https://d3js.org/d3.v5.min.js"></script>
  		<script src="https://d3js.org/d3-collection.v1.min.js"></script>
  		<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  		<script src="https://d3js.org/d3-request.v1.min.js"></script>

		<script type="text/javascript">
    
	var wikiData = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql'

	//var yagoUrl = 'https://cors.bridged.cc/https://yago-knowledge.org/sparql/query'

	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	const subject = urlParams.get('subj');
	
	

	var data2;

	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(loadData);

	function loadData(){
		data2 = new google.visualization.DataTable();

    	//data2.addColumn('string', 'ID');
		data2.addColumn({ type: 'string', label: 'Predicate', id: 'pName'});
		data2.addColumn({ type: 'string', label: 'Object', id: 'oName'});
		data2.addColumn({ type: 'date', label: 'Start Date', id: 'start'});
		data2.addColumn({ type: 'date', label: 'End Date', id: 'end'});
		data2.addColumn({ type: 'string', role: 'tooltip', id: 'link', 'p': {'html': true} });


	}

	//First SPARQL query for non-star triples
	var datesQuery = `
		PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
		PREFIX wikibase: <http://wikiba.se/ontology#>
		PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		SELECT ?pred ?obj ?pName WHERE {
  			<`+subject+`> ?pred ?obj.
  			FILTER ( (datatype(?obj) = xsd:dateTime) || (datatype(?obj) = xsd:date) || (datatype(?obj) = xsd:gYear) || (datatype(?obj) = xsd:gYearMonth) ).
  			?x wikibase:directClaim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
		}
		LIMIT 200
	`;

d3.sparql(wikiData, datesQuery).then(function(data) {

	console.log("We got birth data and death date for QUERY1");
	console.log(data);


	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(loadData2);


	function loadData2(){

		data.forEach(function (arrayItem) {
			var startDate = new Date(arrayItem.obj);
			var endDate = new Date(startDate.getTime()+1000*60*60*24);

	   		data2.addRows([
	   			[ String(arrayItem.pName), String(arrayItem.pName),
	 			   startDate, endDate, String(subject) ]
	   		]);
		});

		//console.log(data2);
	};

	/*const subject2 = urlParams.get('subj2');

	var starQuery2 = `
    	PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		SELECT * WHERE {
  			<< <`+subject2+`> ?pred ?obj >> <http://schema.org/startDate> ?start .
			OPTIONAL{ << <`+subject2+`> ?pred ?obj >> <http://schema.org/endDate> ?end .}
  			?pred rdfs:label ?pName .
  			?obj rdfs:label ?oName .
  			FILTER(LANG(?oName)='en').
		} 
		LIMIT 70
    	`; 

d3.sparql(yagoUrl, starQuery2).then(function(data) {
	console.log("We got data from second QUERY:")
	console.log(data)
}) */

});

    //Second SPARQLStar query
    var starQuery = `
    	SELECT DISTINCT ?pred ?pName ?obj ?oName ?start ?end WHERE {
  			<`+subject+`> ?pred ?statement.
  			?statement ?predPS ?obj;
    			pq:P580 ?start.
  			OPTIONAL { ?statement pq:P582 ?end. FILTER(?end >= ?start).}
  			FILTER(STRSTARTS(STR(?predPS), "http://www.wikidata.org/prop/statement/"))
  			FILTER(STRSTARTS(STR(?pred), "http://www.wikidata.org/prop/"))
  			FILTER(STRSTARTS(STR(?statement), "http://www.wikidata.org/entity/statement/"))
  			?x wikibase:claim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
  			?obj rdfs:label ?oName.
  			FILTER((LANG(?oName)) = "en")
		}
		LIMIT 200`;

d3.sparql(wikiData, starQuery).then(function(data) {

	console.log(data);
	////////////////////////////
	google.charts.load('current', {'packages':['timeline']});
	google.charts.setOnLoadCallback(drawChart);


    function drawChart() {

	    //var today = new Date();
	    //today = Date.now();
	    data.forEach(function (arrayItem) {
	    	var startDate = new Date(arrayItem.start);
			var endDate = arrayItem.end ? new Date(arrayItem.end) : new Date(startDate.getTime()+1000*60*60*24);
	    	data2.addRows([
	    		[ String(arrayItem.pName), String(arrayItem.oName),
		 		  // startDate, endDate , String("http://fabriziorlandi.net/sparql-epoch/GTimeline.html?subj="+arrayItem.obj) ] //new Date(today) ] 
                 startDate, endDate , String("https://yagotimeline.github.io/search.html?subj=" +arrayItem.obj) ] //new Date(today) ]
				 //startDate, endDate , String("file:///F:/3rd%20Year/Semester2/SWENG/yagoTimeline.github.io/search.html?subj="+arrayItem.obj) ] //new Date(today) ]

	    	]);
	    });

		// sort startDate column
    	data2.sort({
      		column: 2,
      		desc: false
    	});

	    console.log(data2);

	    var options = {
		    //height: 1000,
		    timeline: {
		    	groupByRowLabel: false
		    }
		};

		var chart = new google.visualization.Timeline(document.getElementById('chart_div'));

		google.visualization.events.addListener(chart, 'select', function () {
    		var selection = chart.getSelection();
    		if (selection.length > 0) {
      			window.open(data2.getValue(selection[0].row, 4), '_self'); //to open in a new tab use -> '_blank');
      			console.log(data2.getValue(selection[0].row, 4));
    		}
  		});

	    chart.draw(data2, options);

	};
});

		</script>
	</head>
	<body>
		<h3>Insert a resource name (e.g. "Q937" (Albert_Einstein) or "Q458" (European_Union) or "Q668" (India) ) to start exploring timelines:</h3>
		<a href='https://www.wikidata.org/wiki/Special:Search' target="_blank">Use this website to see what code your query responds to in the wikidata SPARQL databse</a>
		<br>
		<input type="text" id="text" />
		
		<!--<input type="button" id="btn" value="Submit" onClick="javascript: window.open('http://fabriziorlandi.net/sparql-epoch/GTimeline.html?subj=http://yago-knowledge.org/resource/' + document.getElementById('text').value, '_self');" /> !-->
         <input type="button" id="btn" value="Submit" onClick="javascript: window.open('http://yagoTimeline.github.io/search.html?subj=http://www.wikidata.org/entity/' + document.getElementById('text').value, '_self');" /> 
		<!-- <input type="button" id="btn" value="Submit" onClick="javascript: window.open('file:///F:/3rd%20Year/Semester2/SWENG/yagoTimeline.github.io/search.html?subj=http://www.wikidata.org/entity/' + document.getElementById('text').value, '_self');" /> !-->
		
		<p>Or click on the items in the timeline below:</p>
		<div id="chart_div" style="overflow-x: hidden; overflow-y: scroll; height: 800px; "></div>
	</body>
</html> 