<html>

<head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    <script src="https://unpkg.com/timelines-chart"></script>
   


    <script type="text/javascript">

        const myChart = TimelinesChart();
        var wikiData = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql'		// Link to access wiki data SPARQL database

        const queryString = window.location.search;										// returns: ?subj=...								

        const urlParams = new URLSearchParams(queryString);
        const subject = urlParams.get('subj');											// isolates subj eg: https://www.wikidata.org/wiki/Q937

        var data2;
         // first query
        var dataS = []; // second Q

        //google.charts.load('current', {'packages':['timeline']});
        // google.charts.setOnLoadCallback(loadData);

        // function loadData(){
        // 	data2 = new google.visualization.DataTable();

        // 	//data2.addColumn('string', 'ID');
        // 	data2.addColumn({ type: 'string', label: 'Predicate', id: 'pName'});
        // 	data2.addColumn({ type: 'string', label: 'Object', id: 'oName'});
        // 	data2.addColumn({ type: 'date', label: 'Start Date', id: 'start'});
        // 	data2.addColumn({ type: 'date', label: 'End Date', id: 'end'});
        // 	data2.addColumn({ type: 'string', role: 'tooltip', id: 'link', 'p': {'html': true} });


        // }

        // First SPARQL query for non-star triples
        // retrieves birth/start date & death/end date
        var datesQuery = `
		PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
		PREFIX wikibase: <http://wikiba.se/ontology#>
		PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		SELECT ?pred ?obj ?pName WHERE {
  			<`+ subject + `> ?pred ?obj.
  			FILTER ( (datatype(?obj) = xsd:dateTime) || (datatype(?obj) = xsd:date) || (datatype(?obj) = xsd:gYear) || (datatype(?obj) = xsd:gYearMonth) ).
  			?x wikibase:directClaim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
		}
		LIMIT 200
	`;  
        
       
        
      //  var dataQ = {};
        												// Assume query has no end/death date, set to current date
   
            function getQueryData(){

        d3.sparql(wikiData, datesQuery).then(function (data) {
            
            console.log("We got birth data and death date for QUERY1");
            console.log(data);
            dataQ = data.slice();
            console.log(dataQ);
        
          // return data;
        });

         return dataQ;
    }

        
       
       // var Test = getQueryData();
       // console.log(Test);

     
         
        

        //Second SPARQLStar query
        // Finds data between birth/start date & death/end date or present date
        var starQuery = `
    	SELECT DISTINCT ?pred ?pName ?obj ?oName ?start ?end WHERE {
  			<`+ subject + `> ?pred ?statement.
  			?statement ?predPS ?obj;
    			pq:P580 ?start.
  			OPTIONAL { ?statement pq:P582 ?end. FILTER(?end >= ?start).}
  			FILTER(STRSTARTS(STR(?predPS), "http://www.wikidata.org/prop/statement/"))
  			FILTER(STRSTARTS(STR(?pred), "http://www.wikidata.org/prop/"))
  			FILTER(STRSTARTS(STR(?statement), "http://www.wikidata.org/entity/statement/"))
  			?x wikibase:claim ?pred;
    			rdfs:label ?pName.
  			FILTER((LANG(?pName)) = "en")
  			?obj rdfs:label ?oName.
  			FILTER((LANG(?oName)) = "en")
		}
		LIMIT 200`;
        

        d3.sparql(wikiData, starQuery).then(function (data) {

            //console.log(data);
            ////////////////////////////
            //google.charts.load('current', { 'packages': ['timeline'] });
            // google.charts.setOnLoadCallback(drawChart);
         
           
            

            function getRandomData(ordinal = false) {
             console.log("David");
              console.log(data);
             var groups = 1;
             var startDate;
             var endDate;
             var pName;
             var oName;
               const NGROUPS = groups;
               var MINTIME = data[0].start;
             // MAXLINES = 15,
             // MAXSEGMENTS = 20,
             // MAXCATEGORIES = 20,
           

             var deathDate = new Date();

             data.forEach(function (arrayItem) {
                startDate = new Date(arrayItem.start);
                //console.log(startDate);
                endDate = new Date(startDate.getTime()+1000*60*60*24);
                pName = arrayItem.pName;
                oName = arrayItem.oName;

                if(arrayItem.pName ==="date of death")									// There is a death/end date
			{
				console.log("Has DEATH DATE");
				endDate = new Date(arrayItem.end);
			}
                if(startDate<MINTIME){
                    MINTIME = startDate;
              }
                
                })
             console.log(MINTIME);

             return [...Array(NGROUPS).keys()].map(i => ({
                 group: subject,
                 data: getGroupData()
             }));

             //

             // the group is the subject -- Albert Einstein = g1
             function getGroupData() {

                 return [...Array(data.length).keys()].map(i => ({
                     label: data[i].oName,
                     data: getSegmentsData()
                 }));

                 //
                 //ie the bars in the timeline
                 function getSegmentsData() {
             
                     const nSegments = data.length,
                         segMaxLength = Math.round(((new Date()) - MINTIME) / nSegments);
                     let runLength = MINTIME;
                    return [...Array(1).keys()].map(i => {
                        start = data[i].start,
                       // console.log(start);
                         end = data[i].end;

                        runLength = new Date(start.getTime() + segMaxLength);

                         return {
                             timeRange: [start, end],
                             val: data[i].pName,
                             //labelVal: is optional - only displayed in the labels
                         };
                     });
                 }
             }
         }
         TimelinesChart()
		 	.data(getRandomData(true))
		 	.zQualitative(true)
		 	(document.getElementById('chart_div'));
                  
        });
           
        
    
   
    
        /*
        
        d3 graph
        
        */
        //sets data for chart
       
       

         
        //     // draws chart
 
        /*
        d3 end
        */


        


    </script>
</head>

<body>
    <style>
    
    </style>
    <h3>Insert a resource name (e.g. "Albert_Einstein" or "European_Union" etc), select the corresponding query from the
        drop down list and press "Submit" to start exploring timelines:</h3>
    <input type="text" class="searchbox" id="text" />
    <input type='hidden' id='textID' />
    <!-- enter local host info -->
    <input type="button" id="btn" value="Submit"    
       
        onClick="javascript: window.open('C:/Users/soap1/Documents/GitHub/yagoTimeline.github.io/newSearch.html?subj=http://www.wikidata.org/entity/' + document.getElementById('textID').value, '_self');" />
    --> 
    <!-- <input type="button" id="btn" value="Submit" onClick="javascript: window.open('file:///F:/3rd%20Year/Semester2/SWENG/yagoTimeline.github.io/search.html?subj=http://www.wikidata.org/entity/' + document.getElementById('textID').value, '_self');" /> -->

    <p>Or click on the items in the timeline below:</p>
    <div id="chart_div" style="overflow-x: scroll; overflow-y: scroll; height: 85%; width: 100%;font-size: 11px; "></div>

    <script>
           
    </script>

    <!-- Search wikiData SPARQL database and retrieve corrsepond Qxyz-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        $(".searchbox").autocomplete({
            source: function (request, response) {
                console.log(request.term);
                $.ajax({
                    url: "https://www.wikidata.org/w/api.php",
                    dataType: "jsonp",
                    data: {
                        'action': "wbsearchentities",
                        'format': "json",
                        'language': "en",
                        'search': request.term
                    },
                    success: function (data) {
                        //response(data.search);
                        response($.map(data.search, function (item) {
                            return {
                                label: item.label + " (" + item.description + ")",
                                value: item.label,
                                id: item.id,
                                description: item.description
                            }
                        }));
                    }
                });
            },
            minLength: 3,
            select: function (event, ui) {
                console.log("Selected: " + ui.item.label + ", having the Wikidata entity: " + ui.item.id);
                $("#text").val(ui.item.value);
                $("#textID").val(ui.item.id); return false;
            }
        });
    </script>
</body>

</html>